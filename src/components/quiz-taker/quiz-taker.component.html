<div class="glass-card shadow-lg rounded-2xl p-6 max-w-4xl mx-auto">
  @switch (quizState()) {
    @case ('selection') {
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-white">اختر اختبارًا لتبدأ</h2>
        <button (click)="viewHistory()" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 btn-3d border-indigo-800">
          عرض السجل
        </button>
      </div>
      @if (quizzes().length > 0) {
        <ul class="space-y-3">
          @for (quiz of quizzes(); track quiz.id) {
            <li>
              <button (click)="startQuiz(quiz)" class="w-full text-right p-4 bg-gray-800/50 rounded-lg hover:bg-indigo-600/30 border border-transparent hover:border-indigo-500 transition-all group">
                <span class="font-semibold text-lg group-hover:text-indigo-300 transition-colors">{{ quiz.title }}</span>
                <span class="text-sm text-gray-400"> ({{ quiz.questions.length }} أسئلة)</span>
              </button>
            </li>
          }
        </ul>
      } @else {
        <div class="text-center p-8 border-2 border-dashed border-gray-700 rounded-lg">
          <p class="text-gray-400">لا توجد اختبارات متاحة.</p>
          <a routerLink="/quiz-maker" class="mt-4 inline-block px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">أنشئ اختبارًا جديدًا</a>
        </div>
      }
    }
    @case ('taking') {
      @if(selectedQuiz(); as quiz) {
        @if (currentQuestion(); as question) {
          <div>
            <div class="flex justify-between items-baseline mb-4">
                <h2 class="text-xl font-bold text-white">{{ quiz.title }}</h2>
                <span class="text-gray-400">السؤال {{ currentQuestionIndex() + 1 }} من {{ quiz.questions.length }}</span>
            </div>
            
            <div class="w-full bg-gray-700 rounded-full h-2.5 mb-4">
              <div class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" [style.width]="(currentQuestionIndex() + 1) / quiz.questions.length * 100 + '%'"></div>
            </div>

            <p class="text-lg mb-6 p-4 bg-gray-900/50 rounded-lg">{{ question.text }}</p>

            <div class="space-y-3">
              @for (option of question.options; track option; let oIndex = $index) {
                <label class="flex items-center p-4 border border-gray-700 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-700/50" 
                       [class.bg-indigo-600/30]="userAnswers()[question.id] === oIndex"
                       [class.border-indigo-500]="userAnswers()[question.id] === oIndex">
                  <input type="radio" [name]="'q-' + question.id" (change)="selectAnswer(question.id, oIndex)" class="w-5 h-5 text-indigo-600 focus:ring-indigo-500 bg-gray-700 border-gray-600" [checked]="userAnswers()[question.id] === oIndex">
                  <span class="mr-3 text-base">{{ option.text }}</span>
                </label>
              }
            </div>
            
            <div class="flex justify-between mt-8">
                <button (click)="previousQuestion()" [disabled]="currentQuestionIndex() === 0" class="px-6 py-2 border border-gray-600 rounded-lg disabled:opacity-50 hover:bg-gray-700">السابق</button>
                @if (currentQuestionIndex() === quiz.questions.length - 1) {
                    <button (click)="finishQuiz()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 btn-3d border-green-800">إنهاء الاختبار</button>
                } @else {
                    <button (click)="nextQuestion()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 btn-3d border-indigo-800">التالي</button>
                }
            </div>
          </div>
        }
      }
    }
    @case ('results') {
        <div class="text-center">
            <h2 class="text-3xl font-bold text-white mb-4">النتيجة النهائية</h2>
             <div class="relative inline-flex items-center justify-center">
                <p class="text-6xl font-black" 
                   [class.text-green-400]="score() >= 50"
                   [class.text-red-400]="score() < 50">
                   {{ score().toFixed(0) }}<span class="text-4xl">%</span>
                </p>
            </div>
            <p class="text-lg text-gray-300 mt-4 mb-8">
                @if(score() >= 90) { "🎉 ممتاز! عمل رائع!" }
                @else if (score() >= 70) { "👍 جيد جداً! استمر في التقدم." }
                @else if (score() >= 50) { "🙂 جيد. يمكنك تحقيق الأفضل." }
                @else { "💪 لا بأس. حاول مرة أخرى." }
            </p>
            <div class="flex justify-center gap-4">
               <button (click)="reviewAnswers()" class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors btn-3d border-gray-800">
                  مراجعة الإجابات
               </button>
                <button (click)="restart()" class="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors btn-3d border-indigo-800">
                    قائمة الاختبارات
                </button>
            </div>
        </div>
    }
    @case ('review') {
      <div>
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-white">مراجعة الإجابات</h2>
           <button (click)="backToResults()" class="px-4 py-2 text-sm bg-gray-600 text-white rounded-lg hover:bg-gray-700">&larr; العودة للنتيجة</button>
        </div>
        <div class="space-y-6 max-h-[60vh] overflow-y-auto pr-2">
            @if(selectedQuiz(); as quiz) {
              @for(question of quiz.questions; track question.id; let qIndex = $index) {
                <div>
                  <p class="font-semibold mb-2">{{ qIndex + 1 }}. {{ question.text }}</p>
                  <div class="space-y-2">
                    @for(option of question.options; track option; let oIndex = $index) {
                        @let isUserAnswer = userAnswers()[question.id] === oIndex;
                        @let isCorrectAnswer = option.isCorrect;
                        <div class="flex items-center p-2 rounded-md text-sm"
                             [class.bg-green-800/50]="isCorrectAnswer"
                             [class.bg-red-800/50]="isUserAnswer && !isCorrectAnswer">
                             
                            @if(isCorrectAnswer) { <span class="mr-2">✅</span> }
                            @else if(isUserAnswer && !isCorrectAnswer) { <span class="mr-2">❌</span> }
                            @else { <span class="mr-2 opacity-0">⚪</span> }

                            <span [class.line-through]="isUserAnswer && !isCorrectAnswer">{{ option.text }}</span>
                        </div>
                    }
                  </div>
                </div>
              }
            }
        </div>
      </div>
    }
    @case ('history') {
      <div>
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-white">سجل الاختبارات</h2>
          <button (click)="backToSelection()" class="px-4 py-2 text-sm bg-gray-600 text-white rounded-lg hover:bg-gray-700">&larr; العودة</button>
        </div>
        @if (quizHistory().length > 0) {
        <ul class="space-y-3 max-h-96 overflow-y-auto">
          @for (result of quizHistory(); track $index) {
            <li class="flex justify-between items-center p-3 bg-gray-800/50 rounded-lg">
              <div>
                <p class="font-semibold">{{ result.quizTitle }}</p>
                <p class="text-xs text-gray-400">{{ formatDate(result.date) }}</p>
              </div>
              <p class="font-bold text-lg" [class.text-green-400]="result.score >= 50" [class.text-red-400]="result.score < 50">
                {{ result.score.toFixed(0) }}%
              </p>
            </li>
          }
        </ul>
        } @else {
          <p class="text-center text-gray-400 py-8">لا يوجد سجل حتى الآن.</p>
        }
      </div>
    }
  }
</div>